---
title: "Insight drift matrix"
author: "Rebecca M. Kuiper"
date: "`r format(Sys.time(), '%d %B %Y')`"
output:
  #pdf_document:
  #  toc: yes
  html_document:
    toc: true
    toc_float: true
    number_sections: true
#fontsize: 14pt
editor_options:
  chunk_output_type: console
---

<style>
body {
  width: 100%;
  margin: 0 auto;
}
</style>


```{r setup, include = FALSE}
knitr::opts_chunk$set(tidy.opts = list(width.cutoff = 80), tidy = TRUE)
knitr::opts_chunk$set(comment = NA, warning = FALSE)
options(width = 1200) # width console output
```

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.pos = 'H', warning = FALSE, message = FALSE)
```


# Preliminaries

In this file, you can find information and tools/functions that help you interpret the (continous-time) relationships from a drift matrix.  

More information can be found in:  
- https://dspace.library.uu.nl/bitstream/handle/1874/375601/ryan.pdf?sequence=1&isAllowed=y  
- https://www.tandfonline.com/doi/pdf/10.1080/10705511.2018.1431046


To use the discussed tools/functions, you need the following R package and R files (or functions):
```{r, eval = T}
library(expm)
source("phiplot.R")
source("plotIRF.R")
# Possibly: Run the code in these files
```

# Drift

```{r, eval = T}
#Drift (A)
A <- matrix(c( -3.12 , 0.08, 0.00,
                2.56, -2.80, -0.32,
              -11.68, 9.44,-6.64), 3,3, byrow=TRUE)
```

What do the elements of the drift matrix tell us about how our variables relate to one another on a moment-to-moment basis?

<!-- Answer -->
Notice first that all of the auto-effect parameters (i.e. the *diagonal elements*) are negative. This implies that, the further away from baseline or equilibrium each variable is, the faster it will move back towards that equilibrium. Recall that in the discrete-time VAR model, the closer to zero the autoregressive parameter is, the faster it returns to baseline after a shock. Here, the larger in absolute value the diagonal parameter is, the faster it will return to baseline. So we can say that, comparing the diagonal elements, $Y_3$ would appear to return to baseline quicker after a shock than the other two variables.

The off-diagonal elements describe the dynamic relationships between different processes. For instance, the parameter $A_{31} = -11.68$ tells us that $Y_1$ has a strong negative effect on (the rate of change of) $Y_3$. There are strong positive effects from $Y_1$ to $Y_2$ ($A_{21} = 2.56$), and from $Y_2$ to $Y_3$ ($A_{32} = 9.44$). There are much weaker effects of $Y_2$ on $Y_1$  ($A_{12} = .08$) and of $Y_3$ on $Y_2$ ($A_{23} = -.32$). The zero value in $A_{13}$ tells us that $Y_3$ has no direct effect on $Y_1$.


# PhiPlot

```{r, eval = T}
# specify the target interval
dt <- 1 
# use the expm function from package expm, without loading the package
phidt <- expm::expm(A*dt) 
# print results
round(phidt,3)

par(mfrow=c(1,1))
phiplot(est = A, ct = TRUE, seperate = FALSE)
```

Here, the legend tells us which line reflects which lagged parameter. For instance the red solid line reflects the effect of $Y_1(t)$ on itself at a later time point $Y_1(t+\Delta t)$, that is, $\Phi_{11}(\Delta t)$. The blue dotted line reflects the effect of $Y_2(t)$ on $Y_3(t+\Delta t)$, that is, $\Phi_{32}(\Delta t)$, and so forth.

Now that we can see how the lagged effects change depending on the interval, what interesting characteristics can we see? How are the auto-regressive and cross-lagged effects different at one interval than at another? How do they change relative to other effects in the model? Could you have predicted this from looking at the $\boldsymbol{A}$ matrix?

<!-- Answer-->

* Here we can see that, indeed, $Y_3$ has a lower auto-regressive effect than $Y_1$ and $Y_2$ across all values of $\Delta t$.
* The cross-lagged effect $Y_2(t) \rightarrow Y_3(t+\Delta t)$, denoted by the blue dotted line, is strongly positive at shorter intervals, peaking around $\Delta t = .15$.
* The cross-lagged effect $Y_1(t) \rightarrow Y_2(t+\Delta t)$, denoted by the red dashed line, is also positive, but peaks at a later interval (approx $\Delta t = 4$). At shorter intervals ($\Delta t < .6$), this effect is smaller than the $Y_2 \rightarrow Y_3$ effect, but at longer intervals ($\Delta t > .6$), this effect is actually greater, as shown by the crossing of the blue dotted and red dashed lines, respectively.
* The cross-lagged effect $Y_1 \rightarrow Y_3$ is strongly negative at short intervals, as we could have expected form the large and negative drift matrix parameter. However, at longer time-interval $\Delta t > .6$ this effect becomes weakly positive!
* The explanation for this change in sign is that the lagged parameter $\phi_{31}(\Delta t)$ should be interpreted as a *total effect*. While the direct effect of $Y_1$ on $Y_3$ is negative, the indirect effect $Y_1 \rightarrow Y_2 \rightarrow Y_3$ is positive. At shorter intervals, the direct effect is greater than the indirect effect, leading to a net negative relationship. At longer intervals, the reverse is true.
* It's difficult to predict all of these patterns from looking at the $\boldsymbol{A}$ matrix alone. This is because the mapping from the moment-to-moment dynamics to the lagged relationships at a longer interval is non-linear and interdependent. The cross-lagged effect $\Phi_{31}(\Delta t)$, for instance, depends on **all** of the parameters in $\boldsymbol{A}$, not just the moment-to-moment relationship $A_{31}$, and does so in a non-linear way! The reverse then, is also true: The moment-to-moment dynamics are not easy to infer on the basis of looking at the lagged parameters at some longer time-interval.
 

# Impulse response function

Looking at how the parameters change already gives us a pretty good idea of the dynamic behaviour of the underlying system. But there are many other ways we could visualize this. For example, we could plot the evolution of the system under different conditions, that is, how the variable-values change over time given a shock. This is called the **Impulse Response Function** or IRF. A simple function to compute the IRF is supplied in `plotIRF.R`. 

To compute the IRF, we need to supply the model parameters which define the dynamics (`est = A`) and a vector of starting values, that is, the value of the *impulse* for each variable (using the `start` argument). Play around with this function to specify different starting values, and see what behaviour comes out of the system under different conditions. If you specify `start=NULL` starting values will be drawn randomly from a uniform distribution.

<!-- Answer-->

Below we plot the IRF for two different impulses. On the left-hand side, we specify a high positive starting value for $Y_1$ and a starting value of zero (i.e. equilibrium) for $Y_2$ and $Y_3$. We see that $Y_3$ first takes on negative values, and then quickly becomes positive. Eventually, all three variables return to their baseline or equilibrium value of zero around $t=2.5$. On the right-hand side we change the starting value of $Y_2$ to be negative. Now we see that the value of $Y_2$ quickly becomes positive (as a result of the strong positive effect of $Y_1$), and the value of $Y_3$ becomes very strongly negative, before both return to baseline.
 
```{r, eval = T} 
par(mfrow=c(1,2))
plotIRF(est = A, start =  c(1,0,0))
plotIRF(est = A, start =  c(1,-1,0))
```


# Examples for more insight

## Bivariate process

### Uncorrelated relationships

```{r, eval = T}
Drift_bivar <- matrix(c( -3.12, 0,
                          0, -2.80), 2,2, byrow=TRUE)

par(mfrow=c(1,1))
phiplot(est = Drift_bivar, ct = TRUE, seperate = FALSE)

par(mfrow=c(1,2))
plotIRF(est = Drift_bivar, start =  c(1,0))
plotIRF(est = Drift_bivar, start =  c(1,-1))
```


### Correlated relationships

#### All positive cross-relationships

```{r, eval = T}
Drift_bivar <- matrix(c( -3.12,  0.08,
                          2.56, -2.80), 2,2, byrow=TRUE)

par(mfrow=c(1,1))
phiplot(est = Drift_bivar, ct = TRUE, seperate = FALSE)

par(mfrow=c(1,3))
plotIRF(est = Drift_bivar, start =  c(1,0))
plotIRF(est = Drift_bivar, start =  c(0,1))
plotIRF(est = Drift_bivar, start =  c(1,-1))

```

#### Positive and negative cross-relationships

##### Option 1 
```{r, eval = T}
Drift_bivar <- matrix(c( -3.12, -0.08,
                          2.56, -2.80), 2,2, byrow=TRUE)

par(mfrow=c(1,1))
phiplot(est = Drift_bivar, ct = TRUE, seperate = FALSE)

par(mfrow=c(1,3))
plotIRF(est = Drift_bivar, start =  c(1,0))
plotIRF(est = Drift_bivar, start =  c(0,1))
plotIRF(est = Drift_bivar, start =  c(1,-1))

```

##### Option 2
```{r, eval = T}
Drift_bivar <- matrix(c( -3.12,  0.08,
                         -2.56, -2.80), 2,2, byrow=TRUE)

par(mfrow=c(1,1))
phiplot(est = Drift_bivar, ct = TRUE, seperate = FALSE)

par(mfrow=c(1,3))
plotIRF(est = Drift_bivar, start =  c(1,0))
plotIRF(est = Drift_bivar, start =  c(0,1))
plotIRF(est = Drift_bivar, start =  c(1,-1))

```

#### All negative cross-relationships
```{r, eval = T}
Drift_bivar <- matrix(c( -3.12, -0.08,
                         -2.56, -2.80), 2,2, byrow=TRUE)

par(mfrow=c(1,1))
phiplot(est = Drift_bivar, ct = TRUE, seperate = FALSE)

par(mfrow=c(1,3))
plotIRF(est = Drift_bivar, start =  c(1,0))
plotIRF(est = Drift_bivar, start =  c(0,1))
plotIRF(est = Drift_bivar, start =  c(1,-1))

```


## Trivariate process

### Uncorrelated relationships

```{r, eval = T}
Drift_bivar <- matrix(c( -3.12, 0, 0,
                        0, -2.80, 0,
                        0, 0,-6.64), 3,3, byrow=TRUE)

par(mfrow=c(1,1))
phiplot(est = Drift_bivar, ct = TRUE, seperate = FALSE)

par(mfrow=c(1,2))
plotIRF(est = Drift_bivar, start =  c(1,0,0))
plotIRF(est = Drift_bivar, start =  c(1,-1,0))
par(mfrow=c(1,2))
plotIRF(est = Drift_bivar, start =  c(1,0,-1))
plotIRF(est = Drift_bivar, start =  c(1,-1,0.5))
par(mfrow=c(1,2))
plotIRF(est = Drift_bivar, start =  c(1,-1,1))
plotIRF(est = Drift_bivar, start =  c(1,-1,-1))
```

### Correlated relationships

#### All positive cross-relationships 

```{r, eval = T}
Drift_bivar <- matrix(c( -3.12, 0.08, 0.00,
                      2.56, -2.80, 0.32,
                     11.68, 9.44,-6.64), 3,3, byrow=TRUE)

par(mfrow=c(1,1))
phiplot(est = Drift_bivar, ct = TRUE, seperate = FALSE)

par(mfrow=c(1,2))
plotIRF(est = Drift_bivar, start =  c(1,0,0))
plotIRF(est = Drift_bivar, start =  c(1,-1,0))
par(mfrow=c(1,2))
plotIRF(est = Drift_bivar, start =  c(1,0,-1))
plotIRF(est = Drift_bivar, start =  c(1,-1,0.5))
par(mfrow=c(1,2))
plotIRF(est = Drift_bivar, start =  c(1,-1,1))
plotIRF(est = Drift_bivar, start =  c(1,-1,-1))

```

#### Positive and negative cross-relationships

##### One negative

###### One option
```{r, eval = T}
Drift_bivar <- matrix(c( -3.12, 0.08, 0.00,
                      2.56, -2.80, 0.32,
                     -11.68, 9.44,-6.64), 3,3, byrow=TRUE)

par(mfrow=c(1,1))
phiplot(est = Drift_bivar, ct = TRUE, seperate = FALSE)

par(mfrow=c(1,2))
plotIRF(est = Drift_bivar, start =  c(1,0,0))
plotIRF(est = Drift_bivar, start =  c(1,-1,0))
par(mfrow=c(1,2))
plotIRF(est = Drift_bivar, start =  c(1,0,-1))
plotIRF(est = Drift_bivar, start =  c(1,-1,0.5))
par(mfrow=c(1,2))
plotIRF(est = Drift_bivar, start =  c(1,-1,1))
plotIRF(est = Drift_bivar, start =  c(1,-1,-1))

```

###### Another option
```{r, eval = T}
Drift_bivar <- matrix(c( -3.12, 0.08, 0.00,
                      2.56, -2.80, -0.32,
                     11.68, 9.44,-6.64), 3,3, byrow=TRUE)

par(mfrow=c(1,1))
phiplot(est = Drift_bivar, ct = TRUE, seperate = FALSE)

par(mfrow=c(1,2))
plotIRF(est = Drift_bivar, start =  c(1,0,0))
plotIRF(est = Drift_bivar, start =  c(1,-1,0))
par(mfrow=c(1,2))
plotIRF(est = Drift_bivar, start =  c(1,0,-1))
plotIRF(est = Drift_bivar, start =  c(1,-1,0.5))
par(mfrow=c(1,2))
plotIRF(est = Drift_bivar, start =  c(1,-1,1))
plotIRF(est = Drift_bivar, start =  c(1,-1,-1))

```


##### Two negative

```{r, eval = T}
Drift_bivar <- matrix(c( -3.12, 0.08, 0.00,
                      2.56, -2.80, -0.32,
                     -11.68, 9.44,-6.64), 3,3, byrow=TRUE)

par(mfrow=c(1,1))
phiplot(est = Drift_bivar, ct = TRUE, seperate = FALSE)

par(mfrow=c(1,2))
plotIRF(est = Drift_bivar, start =  c(1,0,0))
plotIRF(est = Drift_bivar, start =  c(1,-1,0))
par(mfrow=c(1,2))
plotIRF(est = Drift_bivar, start =  c(1,0,-1))
plotIRF(est = Drift_bivar, start =  c(1,-1,0.5))
par(mfrow=c(1,2))
plotIRF(est = Drift_bivar, start =  c(1,-1,1))
plotIRF(est = Drift_bivar, start =  c(1,-1,-1))

```

#### All negative cross-relationships 

```{r, eval = T}
Drift_bivar <- matrix(c( -3.12, -0.08, -0.00,
                      -2.56, -2.80, -0.32,
                     -11.68, -9.44,-6.64), 3,3, byrow=TRUE)

par(mfrow=c(1,1))
phiplot(est = Drift_bivar, ct = TRUE, seperate = FALSE)

par(mfrow=c(1,2))
plotIRF(est = Drift_bivar, start =  c(1,0,0))
plotIRF(est = Drift_bivar, start =  c(1,-1,0))
par(mfrow=c(1,2))
plotIRF(est = Drift_bivar, start =  c(1,0,-1))
plotIRF(est = Drift_bivar, start =  c(1,-1,0.5))
par(mfrow=c(1,2))
plotIRF(est = Drift_bivar, start =  c(1,-1,1))
plotIRF(est = Drift_bivar, start =  c(1,-1,-1))

```